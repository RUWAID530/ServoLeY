// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Types Enum
enum UserType {
  CUSTOMER
  PROVIDER
  ADMIN
}

// Provider Types Enum
enum ProviderType {
  FREELANCER
  STORE
}

// Order Status Enum
enum OrderStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  REJECTED
}

// Transaction Types Enum
enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  COMMISSION
  WITHDRAWAL
}

// Payment Methods Enum
enum PaymentMethod {
  UPI
  CARD
  NET_BANKING
  WALLET
}

// User Model
model User {
  id         String   @id @default(cuid())
  email      String?  @unique
  phone      String?  @unique
  userType   UserType
  isVerified Boolean  @default(false)
  isActive   Boolean  @default(true)
  isBlocked  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Profile Information
  profile Profile?

  // Provider specific fields
  provider Provider?

  // Wallet
  wallet Wallet?

  // Orders
  customerOrders Order[] @relation("CustomerOrders")
  providerOrders Order[] @relation("ProviderOrders")

  // Reviews
  reviewsGiven    Review[] @relation("Reviewer")
  reviewsReceived Review[] @relation("Reviewee")

  // Support Tickets
  supportTickets Ticket[] @relation("UserTickets")

  // OTP
  otps OTP[]

  // Chat Messages
  sentMessages     Message[] @relation("Sender")
  receivedMessages Message[] @relation("Receiver")

  // Payment Orders
  paymentOrders PaymentOrder[]

  // Call Sessions
  customerCalls CallSession[] @relation("CustomerCalls")
  providerCalls CallSession[] @relation("ProviderCalls")

  // Notifications
  notifications           Notification[]
  notificationTokens      NotificationToken[]
  notificationPreferences NotificationPreferences?

  // Admin Actions
  adminActions AdminAction[] @relation("AdminActions")

  // Report Schedules
  reportSchedules ReportSchedule[] @relation("ReportSchedules")

  // Cancellations and suspect flag
  cancellationsCount Int     @default(0)
  isSuspect          Boolean @default(false)

  @@map("users")
}

// Profile Model
model Profile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName String
  lastName  String
  avatar    String?
  address   String?
  pincode   String?
  city      String?
  state     String?
  country   String  @default("India")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("profiles")
}

// Provider Model
model Provider {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessName  String
  providerType  ProviderType
  category      String
  area          String
  address       String
  panNumber     String
  aadhaarNumber String
  gstNumber     String?
  bankAccount   String?
  upiId         String?

  isVerified  Boolean @default(false)
  isActive    Boolean @default(true)
  rating      Float   @default(0)
  totalOrders Int     @default(0)
  isOnline    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Services offered by provider
  services Service[]

  // Orders are handled through the User model

  // Reviews received
  reviews Review[] @relation("ProviderReviews")

  // Locations
  locations ProviderLocation[]

  @@map("providers")
}

// Service Model
model Service {
  id         String   @id @default(cuid())
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  name           String
  description    String
  category       String
  price          Float
  basePrice      Float?
  offerPercent   Int?    @default(0)
  estimatedTime  Int? // minutes
  warrantyMonths Int? // months
  duration       Int // in minutes
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Orders for this service
  orders Order[]

  @@map("services")
}

// Wallet Model
model Wallet {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Transactions
  transactions Transaction[]

  @@map("wallets")
}

// Transaction Model
model Transaction {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  amount        Float
  type          TransactionType
  description   String
  paymentMethod PaymentMethod?
  orderId       String?

  createdAt DateTime @default(now())

  @@map("transactions")
}

// Order Model
model Order {
  id         String  @id @default(cuid())
  customerId String
  customer   User    @relation("CustomerOrders", fields: [customerId], references: [id])
  providerId String
  provider   User    @relation("ProviderOrders", fields: [providerId], references: [id])
  serviceId  String
  service    Service @relation(fields: [serviceId], references: [id])

  status      OrderStatus @default(PENDING)
  totalAmount Float
  commission  Float       @default(0)

  // Order details
  serviceDate DateTime
  address     String
  notes       String?

  // Cancellation
  cancelledBy  String?
  cancelReason String?
  cancelledAt  DateTime?

  // Completion
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Reviews
  review Review?

  // Call Sessions
  callSessions CallSession[]

  // Virtual number assignment
  virtualAssignment VirtualAssignment?

  @@map("orders")
}

// Virtual Number Pool for masked calling
model VirtualNumber {
  id          String  @id @default(cuid())
  phoneNumber String  @unique
  isAssigned  Boolean @default(false)

  assignments VirtualAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("virtual_numbers")
}

// Assignment of a virtual number to an order
model VirtualAssignment {
  id              String        @id @default(cuid())
  orderId         String        @unique
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  virtualNumberId String
  virtualNumber   VirtualNumber @relation(fields: [virtualNumberId], references: [id], onDelete: Cascade)
  status          String        @default("ASSIGNED") // ASSIGNED, RELEASED
  assignedAt      DateTime      @default(now())
  releasedAt      DateTime?

  @@map("virtual_assignments")
}

// Review Model
model Review {
  id      String @id @default(cuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation("Reviewer", fields: [reviewerId], references: [id])

  revieweeId String
  reviewee   User   @relation("Reviewee", fields: [revieweeId], references: [id])

  providerId String?
  provider   Provider? @relation("ProviderReviews", fields: [providerId], references: [id])

  rating  Int
  comment String?

  createdAt DateTime @default(now())

  @@map("reviews")
}

// OTP Model
model OTP {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  code      String
  type      String // "SMS" or "EMAIL"
  isUsed    Boolean  @default(false)
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@map("otps")
}

// Message Model (for chat)
model Message {
  id         String @id @default(cuid())
  senderId   String
  sender     User   @relation("Sender", fields: [senderId], references: [id])
  receiverId String
  receiver   User   @relation("Receiver", fields: [receiverId], references: [id])

  content String
  orderId String?

  createdAt DateTime @default(now())

  @@map("messages")
}

// Support Ticket Model
model Ticket {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserTickets", fields: [userId], references: [id])

  subject     String
  description String
  status      String @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority    String @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tickets")
}

// Payment Order Model
model PaymentOrder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  orderId       String  @unique
  paymentId     String?
  amount        Float
  currency      String  @default("INR")
  paymentMethod String
  status        String  @default("PENDING") // PENDING, COMPLETED, FAILED, CANCELLED
  type          String // WALLET_TOPUP, SERVICE_BOOKING
  signature     String?
  metadata      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payment_orders")
}

// Call Session Model
model CallSession {
  id         String  @id @default(cuid())
  customerId String
  customer   User    @relation("CustomerCalls", fields: [customerId], references: [id])
  providerId String
  provider   User    @relation("ProviderCalls", fields: [providerId], references: [id])
  orderId    String?
  order      Order?  @relation(fields: [orderId], references: [id])

  twilioCallSid String?
  customerPhone String
  providerPhone String
  status        String    @default("INITIATED") // INITIATED, RINGING, ANSWERED, COMPLETED, FAILED, NO-ANSWER
  duration      Int? // in seconds
  startedAt     DateTime?
  endedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Call logs
  callLogs CallLog[]

  @@map("call_sessions")
}

// Call Log Model
model CallLog {
  id            String      @id @default(cuid())
  callSessionId String
  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  status    String
  duration  Int?
  timestamp DateTime @default(now())

  @@map("call_logs")
}

// Notification Model
model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title  String
  body   String
  data   Json?
  type   String // PUSH, EMAIL, SMS, ORDER, MESSAGE, SYSTEM
  status String    @default("SENT") // SENT, DELIVERED, READ, FAILED
  readAt DateTime?

  createdAt DateTime @default(now())

  @@map("notifications")
}

// FCM / push notification tokens per device
model NotificationToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  platform  String?
  createdAt DateTime @default(now())

  @@map("notification_tokens")
}

// Notification Preferences Model
model NotificationPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  pushEnabled  Boolean @default(true)
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(true)
  orderUpdates Boolean @default(true)
  messages     Boolean @default(true)
  promotions   Boolean @default(false)
  systemAlerts Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

// Admin Action Model
model AdminAction {
  id      String @id @default(cuid())
  adminId String
  admin   User   @relation("AdminActions", fields: [adminId], references: [id])

  action   String // BLOCK_USER, UNBLOCK_USER, CANCEL_ORDER, etc.
  targetId String // ID of the target (user, order, etc.)
  details  Json? // Additional details about the action

  createdAt DateTime @default(now())

  @@map("admin_actions")
}

// FAQ Model
model FAQ {
  id       String @id @default(cuid())
  question String
  answer   String
  category String
  order    Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("faqs")
}

// Report Schedule Model
model ReportSchedule {
  id      String @id @default(cuid())
  adminId String
  admin   User   @relation("ReportSchedules", fields: [adminId], references: [id])

  reportType String // user_analytics, order_analytics, financial_report, support_analytics, comprehensive
  frequency  String // daily, weekly, monthly
  email      String
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("report_schedules")
}

// Geo Zone covering parts of Tirunelveli
model Zone {
  id       String  @id @default(cuid())
  name     String  @unique
  city     String
  polygon  Json // Array of [lng,lat] pairs
  isActive Boolean @default(true)

  providerLocations ProviderLocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@map("zones")
}

// Provider live or typical service location
model ProviderLocation {
  id         String   @id @default(cuid())
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  lat        Float
  lng        Float
  address    String?
  zoneId     String?
  zone       Zone?    @relation(fields: [zoneId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([zoneId])
  @@index([lat, lng])
  @@map("provider_locations")
}
